<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FlowChart AI Generator</title>

  <!-- Tailwind（見た目整える） -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Mermaid（図の描画） -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

  <style>
    /* Mermaidを中央に収めやすくするための補助 */
    .mermaid svg { max-width: none !important; }
  </style>
</head>

<body class="bg-slate-50 min-h-screen">
  <div class="max-w-4xl mx-auto px-4 py-8 md:py-12">
    <header class="mb-10 text-center">
      <h1 class="text-3xl font-extrabold text-slate-800 flex items-center justify-center gap-2">
        <span class="inline-flex items-center justify-center w-9 h-9 rounded-lg bg-blue-600 text-white font-black">M</span>
        FlowChart AI Generator
      </h1>
      <p class="mt-2 text-slate-500">文章を貼るだけで、整理された業務フロー図を自動作成</p>
    </header>

    <main class="space-y-8">
      <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
        <label class="block text-sm font-semibold text-slate-700 mb-2">業務フローの説明</label>
        <textarea
          id="inputText"
          class="w-full h-40 p-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all resize-none text-slate-800"
          placeholder="業務フローを自然な日本語で記述してください。
例: 顧客から問い合わせが来たら、まず内容を確認する。不備があれば差し戻す。問題なければ承認する。"
        ></textarea>

        <div class="mt-3 flex flex-wrap gap-2 items-center justify-between">
          <div class="flex gap-2">
            <button id="ex1" class="text-xs px-3 py-1 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-full transition-colors">
              例: 承認フロー
            </button>
            <button id="ex2" class="text-xs px-3 py-1 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-full transition-colors">
              例: ルーティン
            </button>
          </div>

          <button
            id="btnGenerate"
            class="px-8 py-3 rounded-lg font-bold text-white shadow-lg transition-all flex items-center gap-2 bg-blue-600 hover:bg-blue-700 active:scale-95 disabled:bg-slate-400 disabled:cursor-not-allowed"
            disabled
          >
            図解を生成
          </button>
        </div>

        <div id="hintApi" class="mt-4 hidden p-4 bg-amber-50 border-l-4 border-amber-500 text-amber-800 rounded">
          <div class="font-semibold mb-1">APIキーが未設定です</div>
          <div class="text-sm leading-relaxed">
            下のコード内の<br />
            <span class="font-mono bg-white px-1 rounded">const API_KEY = "ここにAPIを入れる";</span><br />
            の部分を自分のAPIキーに置き換えてください。
          </div>
        </div>
      </section>

      <div id="errorBox" class="hidden p-4 bg-red-50 border-l-4 border-red-500 text-red-700 rounded shadow-sm"></div>

      <section id="resultSection" class="hidden">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4 gap-3">
          <h2 class="text-xl font-bold text-slate-800">生成されたフローチャート</h2>
          <div class="flex flex-wrap gap-2">
            <button
              id="btnDownloadSVG"
              class="px-5 py-2 text-white font-bold rounded-lg shadow transition-all bg-blue-500 hover:bg-blue-600 active:scale-95 disabled:bg-slate-300 disabled:cursor-not-allowed"
              disabled
            >
              SVG保存
            </button>
            <button
              id="btnDownloadPNG"
              class="px-5 py-2 text-white font-bold rounded-lg shadow-lg transition-all bg-green-600 hover:bg-green-700 active:scale-95 disabled:bg-slate-300 disabled:cursor-not-allowed disabled:shadow-none"
              disabled
            >
              PNG保存
            </button>
          </div>
        </div>

        <div id="chartContainer" class="w-full flex justify-center bg-white p-10 rounded-lg border border-slate-200 shadow-sm overflow-auto min-h-[300px]">
          <div id="mermaidTarget" class="w-full"></div>
        </div>

        <details class="mt-6 group border border-slate-200 rounded-lg bg-slate-100 overflow-hidden">
          <summary class="flex items-center justify-between p-4 cursor-pointer hover:bg-slate-200 transition-colors list-none select-none">
            <span class="text-xs text-slate-500 uppercase tracking-wider font-bold">Mermaidコード</span>
            <span class="text-slate-400">▼</span>
          </summary>
          <div class="p-4 pt-0 border-t border-slate-200">
            <pre id="codeBox" class="text-[10px] sm:text-xs text-slate-600 overflow-x-auto whitespace-pre-wrap font-mono py-2"></pre>
          </div>
        </details>

        <div class="mt-4 text-xs text-slate-500 leading-relaxed">
          注意：この方式はブラウザにAPIキーを置くため、公開運用には不向きです。まずは動作確認用の試作品として利用してください。
        </div>
      </section>

      <div id="idleBox" class="border-2 border-dashed border-slate-200 rounded-xl p-20 text-center text-slate-400">
        <p>文章を入力して「図解を生成」をクリックしてください</p>
      </div>
    </main>

    <footer class="mt-20 text-center text-slate-400 text-sm border-t border-slate-200 pt-8 pb-12">
      © <span id="year"></span> FlowChart AI Generator | 業務効率化を支援
    </footer>
  </div>

<script>
  // -----------------------------
  // ここにAPIを入れる（後で置換する）
  const API_KEY = "AIzaSyXXXXXXXXXXXXXXX";
  // 公開運用は不可（キーが漏れます）。動作確認用。

  const SYSTEM_INSTRUCTION = `
あなたは業務効率化のスペシャリストおよびMermaid.jsのエキスパートです。
ユーザーから入力された自然な日本語の業務フロー説明を解析し、正確なMermaid形式のフローチャート（graph TD）を生成してください。

以下のルールを厳守してください：
1. 出力は必ず \`\`\`mermaid で始まり \`\`\` で終わるコードブロック形式で返してください。余計な解説文は一切不要です。
2. 処理ステップは [名称] で囲む。
3. 条件分岐は {条件式} で囲み、矢印には |はい| または |いいえ| などのラベルを付ける。
4. 開始と終了は明示的に ((開始)) や ((終了)) を使う。
5. 日本語のニュアンス（〜なら、〜の場合、同時に、等）を論理的に構造化してください。
6. 背景色やスタイル指定は含めないでください。
  `.trim();

  // UI要素
  const elInput = document.getElementById("inputText");
  const btnGenerate = document.getElementById("btnGenerate");
  const errorBox = document.getElementById("errorBox");
  const resultSection = document.getElementById("resultSection");
  const idleBox = document.getElementById("idleBox");
  const mermaidTarget = document.getElementById("mermaidTarget");
  const codeBox = document.getElementById("codeBox");
  const btnDownloadSVG = document.getElementById("btnDownloadSVG");
  const btnDownloadPNG = document.getElementById("btnDownloadPNG");
  const hintApi = document.getElementById("hintApi");

  document.getElementById("year").textContent = new Date().getFullYear();

  // Mermaid初期化（ページ全体）
  mermaid.initialize({
    startOnLoad: false,
    theme: "neutral",
    securityLevel: "loose",
    fontFamily: "sans-serif",
    flowchart: { useMaxWidth: false, htmlLabels: true },
  });

  const setError = (msg) => {
    if (!msg) {
      errorBox.classList.add("hidden");
      errorBox.textContent = "";
      return;
    }
    errorBox.classList.remove("hidden");
    errorBox.textContent = msg;
  };

  const setReadyForDownload = (ready) => {
    btnDownloadSVG.disabled = !ready;
    btnDownloadPNG.disabled = !ready;
  };

  const setBusy = (busy) => {
    btnGenerate.disabled = busy || !elInput.value.trim();
    btnGenerate.textContent = busy ? "生成中..." : "図解を生成";
  };

  const formatDate = (date) => {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    const h = String(date.getHours()).padStart(2, "0");
    const i = String(date.getMinutes()).padStart(2, "0");
    return `${y}${m}${d}_${h}${i}`;
  };

  // 入力に応じてボタンを有効化
  elInput.addEventListener("input", () => {
    btnGenerate.disabled = !elInput.value.trim();
  });

  // 例ボタン
  document.getElementById("ex1").addEventListener("click", () => {
    elInput.value = "申請を受け取る。内容を確認する。不備があれば差し戻す。不備がなければ承認する。";
    btnGenerate.disabled = false;
  });
  document.getElementById("ex2").addEventListener("click", () => {
    elInput.value = "朝起きたら顔を洗う。その後、天気が良ければ洗濯物をする。雨なら部屋干しをする。最後に朝食を食べる。";
    btnGenerate.disabled = false;
  });

  // APIキー未設定のガード
  const apiKeyIsUnset = () => !API_KEY || API_KEY.includes("ここにAPIを入れる");

  // Gemini呼び出し（REST）
  async function callGemini(promptText) {
    // Gemini API: generateContent
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${encodeURIComponent(API_KEY)}`;

    const body = {
      systemInstruction: { parts: [{ text: SYSTEM_INSTRUCTION }] },
      contents: [{ role: "user", parts: [{ text: promptText }] }],
      generationConfig: { temperature: 0.1 }
    };

    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });

    if (!res.ok) {
      const t = await res.text().catch(() => "");
      throw new Error(`APIエラー: ${res.status} ${res.statusText} ${t}`);
    }

    const data = await res.json();
    const text =
      data?.candidates?.[0]?.content?.parts?.map((p) => p.text).join("") || "";
    return text;
  }

  // Mermaidコード抽出
  function extractMermaid(text) {
    const mermaidMatch = text.match(/```mermaid\s*([\s\S]*?)\s*```/i);
    const genericMatch = text.match(/```\s*([\s\S]*?)\s*```/i);

    let code = "";
    if (mermaidMatch) code = mermaidMatch[1];
    else if (genericMatch) code = genericMatch[1];
    else code = text;

    code = (code || "").trim();
    if (code && !code.startsWith("graph") && !code.startsWith("flowchart")) {
      code = `graph TD\n${code}`;
    }
    return code;
  }

  // Mermaid描画
  async function renderMermaid(code) {
    mermaidTarget.innerHTML = `<div class="mermaid">${code}</div>`;
    await mermaid.run({ nodes: [mermaidTarget.querySelector(".mermaid")] });
  }

  // リトライ（初回失敗対策）
  async function withRetry(fn, retries = 2, delay = 900) {
    try {
      return await fn();
    } catch (e) {
      if (retries <= 0) throw e;
      await new Promise((r) => setTimeout(r, delay));
      return withRetry(fn, retries - 1, delay * 2);
    }
  }

  btnGenerate.addEventListener("click", async () => {
    setError(null);
    setReadyForDownload(false);

    if (apiKeyIsUnset()) {
      hintApi.classList.remove("hidden");
      setError("APIキーが未設定です。");
      return;
    }
    hintApi.classList.add("hidden");

    const input = elInput.value.trim();
    if (!input) return;

    setBusy(true);

    try {
      const prompt = `以下の業務フローをMermaid記法のフローチャートに変換してください：\n\n${input}`;

      const raw = await withRetry(() => callGemini(prompt), 2, 900);
      const code = extractMermaid(raw);

      if (!code || code.length < 5) throw new Error("図解データの生成に失敗しました。");

      codeBox.textContent = code;

      await renderMermaid(code);

      // 表示切替
      idleBox.classList.add("hidden");
      resultSection.classList.remove("hidden");

      // ダウンロード可
      setReadyForDownload(true);
    } catch (e) {
      console.error(e);
      setError("図解の生成に失敗しました。もう一度「生成」ボタンを押してみてください。");
    } finally {
      setBusy(false);
    }
  });

  // SVG保存
  btnDownloadSVG.addEventListener("click", () => {
    const svg = document.querySelector("#chartContainer svg");
    if (!svg) return alert("SVG要素が見つかりません。");

    const clone = svg.cloneNode(true);

    if (!clone.getAttribute("xmlns")) clone.setAttribute("xmlns", "http://www.w3.org/2000/svg");

    const serializer = new XMLSerializer();
    const svgString = serializer.serializeToString(clone);
    const blob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `flowchart_${formatDate(new Date())}.svg`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // PNG保存（SVG→Canvas変換）
  btnDownloadPNG.addEventListener("click", async () => {
    const svg = document.querySelector("#chartContainer svg");
    if (!svg) return alert("SVG要素が見つかりません。");

    try {
      const serializer = new XMLSerializer();
      const svgString = serializer.serializeToString(svg);
      const svgBlob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
      const url = URL.createObjectURL(svgBlob);

      const img = new Image();
      img.decoding = "async";
      img.onload = () => {
        const scale = 3;
        const canvas = document.createElement("canvas");
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext("2d");
        ctx.scale(scale, scale);
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0);

        const pngUrl = canvas.toDataURL("image/png", 1.0);
        const a = document.createElement("a");
        a.href = pngUrl;
        a.download = `flowchart_${formatDate(new Date())}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        URL.revokeObjectURL(url);
      };

      img.onerror = () => {
        URL.revokeObjectURL(url);
        alert("PNG変換に失敗しました。");
      };

      img.src = url;
    } catch (e) {
      console.error(e);
      alert("PNGの保存に失敗しました。");
    }
  });
</script>
</body>
</html>
