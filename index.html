<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlowChart AI Generator (Gemini Powered)</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>

  <script type="importmap">
  {
    "imports": {
      "@google/genai": "https://esm.sh/@google/genai@^1.37.0"
    }
  }
  </script>

  <style>
    /* あなたのアプリのダークブルー基調のデザインを継承 */
    body { background-color: #0b1220; color: #e5e7eb; }
    .card { background: rgba(17,26,46,.82); border: 1px solid #24324d; border-radius: 14px; }
  </style>
</head>
<body class="p-4 md:p-8">
  <div class="max-w-5xl mx-auto">
    <header class="mb-8">
      <h1 class="text-2xl font-bold text-amber-400">業務フロー図解生成 AI</h1>
      <p class="text-gray-400 text-sm">Gemini AIが文章を解析し、最適なフローチャートを自動生成します。</p>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="card p-6">
        <label class="block text-sm mb-2">業務内容を入力</label>
        <textarea id="inputText" class="w-full h-48 bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-amber-500 outline-none" placeholder="例：申請を受け取る。内容を確認し、不備があれば差し戻す。なければ承認する。"></textarea>
        
        <div class="mt-4 flex flex-wrap gap-2">
          <button id="btnGenerate" class="bg-amber-500 hover:bg-amber-600 text-black font-bold py-2 px-6 rounded-lg transition-all">図解を生成</button>
          <button id="btnDownloadPNG" class="bg-slate-700 hover:bg-slate-600 py-2 px-4 rounded-lg text-sm disabled:opacity-50" disabled>PNG保存</button>
        </div>
        <div id="status" class="mt-4 text-xs text-gray-500 italic">準備完了</div>
      </div>

      <div class="card p-6">
        <h2 class="text-sm font-bold mb-4 text-slate-400 uppercase">プレビュー</h2>
        <div id="previewContainer" class="bg-white rounded-lg p-4 min-h-[300px] flex items-center justify-center overflow-auto">
          <div id="diagram" class="w-full text-black"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { GoogleGenAI } from "@google/genai";

    // --- 設定 ---
    // GitHubに公開する場合は、APIキーを直接書かずに運用するのが理想ですが、
    // まず動かすために、ここにご自身のキーを貼り付けて動作確認してください。
    const API_KEY = "AIzaSyDBljntEkcSJdNFtUk3FHch-RRR95o6Cck"; 

    const genAI = new GoogleGenAI(API_KEY);
    const model = genAI.getGenerativeModel({ 
      model: "gemini-1.5-flash",
      systemInstruction: "あなたはMermaid.jsのエキスパートです。入力された業務を解析し、必ず ```mermaid で始まるコードブロックのみを返してください。graph TD形式を使用してください。"
    });

    // --- 要素の取得 ---
    const btnGenerate = document.getElementById('btnGenerate');
    const inputText = document.getElementById('inputText');
    const diagramDiv = document.getElementById('diagram');
    const status = document.getElementById('status');
    const btnDownloadPNG = document.getElementById('btnDownloadPNG');

    // Mermaidの初期化
    mermaid.initialize({ startOnLoad: false, theme: 'neutral' });

    // 生成処理
    btnGenerate.onclick = async () => {
      const text = inputText.value.trim();
      if (!text) return;

      status.innerText = "AIが思考中...";
      btnGenerate.disabled = true;

      try {
        const result = await model.generateContent(text);
        const response = await result.response;
        let code = response.text();
        
        // Mermaidコードの抽出
        code = code.replace(/```mermaid/g, "").replace(/```/g, "").trim();

        status.innerText = "図解を描画中...";
        
        // 描画
        const { svg } = await mermaid.render('id' + Date.now(), code);
        diagramDiv.innerHTML = svg;
        
        status.innerText = "生成完了！";
        btnDownloadPNG.disabled = false;
      } catch (err) {
        console.error(err);
        status.innerText = "エラーが発生しました。APIキーを確認してください。";
      } finally {
        btnGenerate.disabled = false;
      }
    };

    // PNGダウンロード機能
    btnDownloadPNG.onclick = async () => {
      const target = document.getElementById('previewContainer');
      const dataUrl = await htmlToImage.toPng(target, { backgroundColor: '#fff' });
      const link = document.createElement('a');
      link.download = `flowchart-${Date.now()}.png`;
      link.href = dataUrl;
      link.click();
    };
  </script>
</body>
</html>
