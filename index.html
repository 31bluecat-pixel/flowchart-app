<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowChart AI - Ultimate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>
    <script type="importmap">
    { "imports": { "@google/genai": "https://esm.sh/@google/genai@^1.37.0" } }
    </script>
    <style>
        :root { --bg: #0b1220; --accent: #fbbf24; }
        body { background: #0b1220; color: #e5e7eb; font-family: sans-serif; margin: 0; padding: 20px; }
        .glass { background: rgba(17, 26, 46, 0.9); border: 1px solid #24324d; border-radius: 12px; }
        .preview-box { background: white; border-radius: 8px; min-height: 400px; overflow: auto; display: flex; justify-content: center; align-items: center; border: 4px solid #1e293b; }
        textarea { background: #0f172a; border: 1px solid #334155; color: white; border-radius: 8px; padding: 15px; width: 100%; height: 200px; resize: none; }
        .btn-main { background: linear-gradient(to right, #f59e0b, #ea580c); color: black; font-weight: bold; padding: 12px 24px; border-radius: 8px; cursor: pointer; border: none; }
        .btn-main:disabled { opacity: 0.3; cursor: not-allowed; }
        .log-area { background: #000; border: 1px solid #1e293b; padding: 10px; font-family: monospace; font-size: 11px; color: #64748b; height: 100px; overflow-y: auto; margin-top: 10px; }
    </style>
</head>
<body>
    <div style="max-width: 1100px; margin: 0 auto;">
        <header style="margin-bottom: 20px;">
            <h1 style="color: #fbbf24; font-size: 24px; margin: 0;">FlowChart AI Generator</h1>
            <p style="font-size: 12px; color: #94a3b8;">入力された文章からAIがMermaid図解を生成します</p>
        </header>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="glass" style="padding: 20px;">
                <div style="margin-bottom: 10px; font-size: 14px; font-weight: bold;">Step 1: 業務内容を入力</div>
                <textarea id="ai-input" placeholder="例：メールを受信する。内容を確認し、重要なら返信する。そうでなければ削除する。"></textarea>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button id="run-btn" class="btn-main">図解を生成する</button>
                    <button id="save-png" style="background:#334155; color:white; border-radius:8px; padding:0 15px; font-size:12px;" disabled>PNG保存</button>
                </div>
                <div id="debug-log" class="log-area">システム待機中...</div>
            </div>

            <div class="glass" style="padding: 20px;">
                <div style="margin-bottom: 10px; font-size: 14px; font-weight: bold;">Step 2: プレビュー表示</div>
                <div id="capture-area" class="preview-box">
                    <div id="mermaid-target" style="width: 100%; text-align: center; color: #64748b;">ここに図が表示されます</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        // ★★★ここにあなたのAPIキーを貼り付けてください★★★
        const API_KEY = "AIzaSyDBljntEkcSJdNFtUk3FHch-RRR95o6Cck"; 

        const log = (msg) => {
            const el = document.getElementById('debug-log');
            el.innerHTML += `<div>> ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
        };

        const runBtn = document.getElementById('run-btn');
        const mermaidTarget = document.getElementById('mermaid-target');

        // Mermaid初期化
        try {
            mermaid.initialize({ startOnLoad: false, theme: 'neutral' });
            log("Mermaid.js 読み込み成功");
        } catch(e) { log("Mermaid初期化エラー: " + e.message); }

        runBtn.onclick = async () => {
            const input = document.getElementById('ai-input').value;
            if(!input) return alert("文章を入力してください");
            
            runBtn.disabled = true;
            log("Gemini AIに接続中...");

            try {
                const genAI = new GoogleGenAI(API_KEY);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                
                const prompt = `以下の業務フローをMermaid.jsのgraph TD形式で出力してください。コードブロック以外は出力しないでください。\n\n${input}`;
                const result = await model.generateContent(prompt);
                let code = await result.response.text();
                
                // 余計な文字を掃除
                code = code.replace(/```mermaid/g, "").replace(/```/g, "").trim();
                log("AIからの応答を受信。描画を開始します。");

                // 描画処理
                mermaidTarget.innerHTML = "";
                const { svg } = await mermaid.render('graphDiv', code);
                mermaidTarget.innerHTML = svg;
                
                log("描画成功！");
                document.getElementById('save-png').disabled = false;

            } catch (err) {
                log("エラー発生: " + err.message);
                console.error(err);
            } finally {
                runBtn.disabled = false;
            }
        };

        // PNG保存機能
        document.getElementById('save-png').onclick = async () => {
            const dataUrl = await htmlToImage.toPng(document.getElementById('capture-area'));
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = "flowchart.png";
            a.click();
        };
    </script>
</body>
</html>
