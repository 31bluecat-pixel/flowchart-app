set -e

APP_DIR="flowchart-ai-generator"

mkdir -p "$APP_DIR"/{public,src/{components,services,types,styles}}

cat > "$APP_DIR/package.json" <<'JSON'
{
  "name": "flowchart-ai-generator",
  "private": true,
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "@google/genai": "^1.37.0",
    "html-to-image": "^1.11.11",
    "react": "^19.2.3",
    "react-dom": "^19.2.3"
  },
  "devDependencies": {
    "@types/react": "^19.1.8",
    "@types/react-dom": "^19.1.6",
    "@vitejs/plugin-react": "^4.3.4",
    "typescript": "^5.7.3",
    "vite": "^6.0.11"
  }
}
JSON

cat > "$APP_DIR/vite.config.ts" <<'TS'
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";

export default defineConfig({
  plugins: [react()],
});
TS

cat > "$APP_DIR/tsconfig.json" <<'JSON'
{
  "compilerOptions": {
    "target": "ES2022",
    "useDefineForClassFields": true,
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,

    "moduleResolution": "Bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",

    "strict": true,
    "types": ["vite/client"]
  },
  "include": ["src"]
}
JSON

cat > "$APP_DIR/tsconfig.node.json" <<'JSON'
{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "ESNext",
    "moduleResolution": "Bundler",
    "strict": true
  },
  "include": ["vite.config.ts"]
}
JSON

cat > "$APP_DIR/index.html" <<'HTML'
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FlowChart AI Generator</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  </head>
  <body class="bg-slate-50 min-h-screen">
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
HTML

cat > "$APP_DIR/src/styles/index.css" <<'CSS'
html,
body {
  height: 100%;
}
CSS

cat > "$APP_DIR/src/main.tsx" <<'TSX'
import React from "react";
import ReactDOM from "react-dom/client";
import App from "./App";
import "./styles/index.css";

const rootElement = document.getElementById("root");
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

ReactDOM.createRoot(rootElement).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
TSX

cat > "$APP_DIR/src/types/index.ts" <<'TS'
export enum AppStatus {
  IDLE = "IDLE",
  LOADING = "LOADING",
  SUCCESS = "SUCCESS",
  ERROR = "ERROR",
}
TS

cat > "$APP_DIR/src/services/geminiService.ts" <<'TS'
import { GoogleGenAI } from "@google/genai";

const SYSTEM_INSTRUCTION = `
あなたは業務効率化のスペシャリストおよびMermaid.jsのエキスパートです。
ユーザーから入力された自然な日本語の業務フロー説明を解析し、正確なMermaid形式のフローチャート（graph TD）を生成してください。

以下のルールを厳守してください：
1. 出力は必ず \`\`\`mermaid で始まり \`\`\` で終わるコードブロック形式で返してください。余計な解説文は一切不要です。
2. 処理ステップは [名称] で囲む。
3. 条件分岐は {条件式} で囲み、矢印には |はい| または |いいえ| などのラベルを付ける。
4. 開始と終了は明示的に ((開始)) や ((終了)) を使う。
5. 日本語のニュアンス（〜なら、〜の場合、同時に、等）を論理的に構造化してください。
6. 背景色やスタイル指定は含めないでください。
`;

/*
  ここにAPIを入れる

  手順:
  1) .env.example をコピーして .env を作る
  2) .env の VITE_GEMINI_API_KEY=ここにAPIを入れる の右側を、自分のAPIキーに置き換える

  注意:
  .env はGitHubに上げない（.gitignore で除外済み）
*/
const getApiKey = () => {
  const key = import.meta.env.VITE_GEMINI_API_KEY as string | undefined;
  return key?.trim() || "";
};

const withRetry = async <T>(
  fn: () => Promise<T>,
  retries = 2,
  delay = 1000
): Promise<T> => {
  try {
    return await fn();
  } catch (error) {
    if (retries <= 0) throw error;
    await new Promise((resolve) => setTimeout(resolve, delay));
    return withRetry(fn, retries - 1, delay * 2);
  }
};

export const generateFlowChart = async (text: string): Promise<string> => {
  const apiKey = getApiKey();
  if (!apiKey) {
    throw new Error("APIキーが未設定です。.env に VITE_GEMINI_API_KEY を設定してください。");
  }

  const ai = new GoogleGenAI({ apiKey });

  const generate = async () => {
    const response = await ai.models.generateContent({
      model: "gemini-3-flash-preview",
      contents: [
        {
          parts: [
            {
              text: `以下の業務フローをMermaid記法のフローチャートに変換してください：\n\n${text}`,
            },
          ],
        },
      ],
      config: {
        systemInstruction: SYSTEM_INSTRUCTION,
        temperature: 0.1,
      },
    });

    return response.text ?? "";
  };

  const output = (await withRetry(generate)) || "";

  const mermaidMatch = output.match(/```mermaid\s*([\s\S]*?)\s*```/i);
  const genericMatch = output.match(/```\s*([\s\S]*?)\s*```/i);

  let code = "";
  if (mermaidMatch) code = mermaidMatch[1];
  else if (genericMatch) code = genericMatch[1];
  else code = output;

  code = code.trim();
  if (code && !code.startsWith("graph") && !code.startsWith("flowchart")) {
    code = `graph TD\n${code}`;
  }

  return code;
};
TS

cat > "$APP_DIR/src/components/MermaidRenderer.tsx" <<'TSX'
import React, { useEffect, useRef } from "react";

declare global {
  interface Window {
    mermaid: any;
  }
}

interface MermaidRendererProps {
  chart: string;
  onRendered?: () => void;
  onError?: (msg: string) => void;
}

const MermaidRenderer: React.FC<MermaidRendererProps> = ({ chart, onRendered, onError }) => {
  const ref = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (!ref.current || !chart) return;

    ref.current.innerHTML = `<div class="mermaid-target">${chart}</div>`;

    try {
      window.mermaid.initialize({
        startOnLoad: false,
        theme: "neutral",
        securityLevel: "loose",
        fontFamily: "sans-serif",
        flowchart: { useMaxWidth: false, htmlLabels: true },
      });

      const targetNode = ref.current.firstChild as HTMLElement;

      window.mermaid
        .run({ nodes: [targetNode] })
        .then(() => {
          if (onRendered) setTimeout(onRendered, 100);
        })
        .catch((err: any) => {
          console.error("Mermaid run error:", err);
          if (onError) onError("図の描画に失敗しました。構文を確認してください。");
        });
    } catch (err) {
      console.error("Mermaid init error:", err);
      if (onError) onError("Mermaidの初期化に失敗しました。");
    }
  }, [chart, onRendered, onError]);

  return (
    <div
      id="chart-container"
      className="w-full flex justify-center bg-white p-10 rounded-lg border border-slate-200 shadow-sm overflow-auto min-h-[300px]"
      ref={ref}
    />
  );
};

export default MermaidRenderer;
TSX

cat > "$APP_DIR/src/App.tsx" <<'TSX'
import React, { useCallback, useState } from "react";
import { toPng } from "html-to-image";
import MermaidRenderer from "./components/MermaidRenderer";
import { generateFlowChart } from "./services/geminiService";
import { AppStatus } from "./types";

const App: React.FC = () => {
  const [inputText, setInputText] = useState("");
  const [mermaidCode, setMermaidCode] = useState("");
  const [status, setStatus] = useState<AppStatus>(AppStatus.IDLE);
  const [error, setError] = useState<string | null>(null);
  const [isReadyForDownload, setIsReadyForDownload] = useState(false);

  const formatDate = (date: Date) => {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const d = String(date.getDate()).padStart(2, "0");
    const h = String(date.getHours()).padStart(2, "0");
    const i = String(date.getMinutes()).padStart(2, "0");
    return `${y}${m}${d}_${h}${i}`;
  };

  const handleGenerate = useCallback(async () => {
    const trimmedInput = inputText.trim();
    if (!trimmedInput) return;

    setStatus(AppStatus.LOADING);
    setError(null);
    setMermaidCode("");
    setIsReadyForDownload(false);

    try {
      const code = await generateFlowChart(trimmedInput);
      if (!code || code.length < 5) {
        throw new Error("図解データの生成に失敗しました。");
      }
      setMermaidCode(code);
      setStatus(AppStatus.SUCCESS);
    } catch (err: any) {
      console.error("Generation Error:", err);
      const msg =
        err?.message?.includes("APIキー")
          ? "APIキーが未設定です。.env に VITE_GEMINI_API_KEY を設定してください。"
          : "図解の生成に失敗しました。もう一度「生成」ボタンを押してみてください。";
      setError(msg);
      setStatus(AppStatus.ERROR);
    }
  }, [inputText]);

  const handleDownloadPNG = async () => {
    const target = document.getElementById("chart-container");
    if (!target) {
      alert("プレビューエリアが見つかりません。");
      return;
    }

    try {
      const dataUrl = await toPng(target, {
        backgroundColor: "#FFFFFF",
        pixelRatio: 3,
        quality: 1.0,
        style: { padding: "20px", margin: "0" },
      });

      const link = document.createElement("a");
      link.download = `flowchart_${formatDate(new Date())}.png`;
      link.href = dataUrl;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } catch (err: any) {
      console.error("PNG conversion failed:", err);
      alert(`画像の保存に失敗しました: ${err?.message || "不明なエラー"}`);
    }
  };

  const handleDownloadSVG = () => {
    const target = document.getElementById("chart-container");
    const svgElement = target?.querySelector("svg");
    if (!svgElement) {
      alert("SVG要素が見つかりません。");
      return;
    }

    try {
      const svgClone = svgElement.cloneNode(true) as SVGSVGElement;
      if (!svgClone.getAttribute("xmlns")) svgClone.setAttribute("xmlns", "http://www.w3.org/2000/svg");

      const bbox = svgElement.getBBox();
      svgClone.setAttribute("viewBox", `${bbox.x} ${bbox.y} ${bbox.width} ${bbox.height}`);
      svgClone.setAttribute("width", bbox.width.toString());
      svgClone.setAttribute("height", bbox.height.toString());

      let cssText = "";
      try {
        Array.from(document.styleSheets).forEach((sheet) => {
          const s = sheet as CSSStyleSheet;
          if (s.href) return;
          Array.from(s.cssRules).forEach((rule) => {
            if (rule.cssText.includes("mermaid")) cssText += rule.cssText;
          });
        });
      } catch {
        // 取得できない場合は無視
      }

      const styleTag = document.createElementNS("http://www.w3.org/2000/svg", "style");
      styleTag.textContent = cssText;
      svgClone.prepend(styleTag);

      const serializer = new XMLSerializer();
      const svgString = serializer.serializeToString(svgClone);
      const svgBlob = new Blob([svgString], { type: "image/svg+xml;charset=utf-8" });
      const url = URL.createObjectURL(svgBlob);

      const link = document.createElement("a");
      link.href = url;
      link.download = `flowchart_${formatDate(new Date())}.svg`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    } catch (err: any) {
      console.error("SVG download failed:", err);
      alert(`SVGの保存に失敗しました: ${err?.message || "不明なエラー"}`);
    }
  };

  const handleExample = (text: string) => setInputText(text);

  return (
    <div className="max-w-4xl mx-auto px-4 py-8 md:py-12">
      <header className="mb-10 text-center">
        <h1 className="text-3xl font-extrabold text-slate-800 flex items-center justify-center gap-2">
          <svg className="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"
            />
          </svg>
          FlowChart AI Generator
        </h1>
        <p className="mt-2 text-slate-500">文章を貼るだけで、整理された業務フロー図を自動作成</p>
      </header>

      <main className="space-y-8">
        <section className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
          <label className="block text-sm font-semibold text-slate-700 mb-2">業務フローの説明</label>
          <textarea
            className="w-full h-40 p-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all resize-none text-slate-800"
            placeholder={"業務フローを自然な日本語で記述してください。\n例: 顧客から問い合わせが来たら、まず内容を確認する。不備があれば差し戻す。問題なければ承認する。"}
            value={inputText}
            onChange={(e) => setInputText(e.target.value)}
          />

          <div className="mt-3 flex flex-wrap gap-2 items-center justify-between">
            <div className="flex gap-2">
              <button
                onClick={() => handleExample("申請を受け取る。内容を確認する。不備があれば差し戻す。不備がなければ承認する。")}
                className="text-xs px-3 py-1 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-full transition-colors"
              >
                例: 承認フロー
              </button>
              <button
                onClick={() => handleExample("朝起きたら顔を洗う。その後、天気が良ければ洗濯物をする。雨なら部屋干しをする。最後に朝食を食べる。")}
                className="text-xs px-3 py-1 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-full transition-colors"
              >
                例: ルーティン
              </button>
            </div>

            <button
              onClick={handleGenerate}
              disabled={status === AppStatus.LOADING || !inputText.trim()}
              className={`px-8 py-3 rounded-lg font-bold text-white shadow-lg transition-all flex items-center gap-2 ${
                status === AppStatus.LOADING || !inputText.trim()
                  ? "bg-slate-400 cursor-not-allowed"
                  : "bg-blue-600 hover:bg-blue-700 active:scale-95"
              }`}
            >
              {status === AppStatus.LOADING ? (
                <>
                  <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path
                      className="opacity-75"
                      fill="currentColor"
                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                    ></path>
                  </svg>
                  生成中...
                </>
              ) : (
                "図解を生成"
              )}
            </button>
          </div>
        </section>

        {error && (
          <div className="p-4 bg-red-50 border-l-4 border-red-500 text-red-700 rounded shadow-sm">
            <p className="flex items-center gap-2 font-medium">
              <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fillRule="evenodd"
                  d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                  clipRule="evenodd"
                />
              </svg>
              {error}
            </p>
          </div>
        )}

        {mermaidCode && (
          <section className="animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-4 gap-3">
              <h2 className="text-xl font-bold text-slate-800">生成されたフローチャート</h2>
              <div className="flex flex-wrap gap-2">
                <button
                  onClick={handleDownloadSVG}
                  disabled={!isReadyForDownload}
                  className={`px-5 py-2 text-white font-bold rounded-lg shadow flex items-center gap-2 transition-all ${
                    isReadyForDownload ? "bg-blue-500 hover:bg-blue-600 active:scale-95" : "bg-slate-300 cursor-not-allowed"
                  }`}
                >
                  SVG保存
                </button>
                <button
                  onClick={handleDownloadPNG}
                  disabled={!isReadyForDownload}
                  className={`px-5 py-2 text-white font-bold rounded-lg shadow-lg flex items-center gap-2 transition-all ${
                    isReadyForDownload ? "bg-green-600 hover:bg-green-700 active:scale-95" : "bg-slate-300 cursor-not-allowed shadow-none"
                  }`}
                >
                  PNG保存
                </button>
              </div>
            </div>

            <MermaidRenderer
              chart={mermaidCode}
              onRendered={() => setIsReadyForDownload(true)}
              onError={(msg) => {
                setError(msg);
                setIsReadyForDownload(false);
              }}
            />

            <details className="mt-6 group border border-slate-200 rounded-lg bg-slate-100 overflow-hidden transition-all">
              <summary className="flex items-center justify-between p-4 cursor-pointer hover:bg-slate-200 transition-colors list-none select-none">
                <div className="flex items-center gap-2">
                  <span className="text-xs text-slate-500 uppercase tracking-wider font-bold">Mermaidコード</span>
                </div>
                <svg className="w-4 h-4 text-slate-400 group-open:rotate-180 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                </svg>
              </summary>
              <div className="p-4 pt-0 border-t border-slate-200">
                <pre className="text-[10px] sm:text-xs text-slate-600 overflow-x-auto whitespace-pre-wrap font-mono py-2">{mermaidCode}</pre>
              </div>
            </details>
          </section>
        )}

        {status === AppStatus.IDLE && !mermaidCode && (
          <div className="border-2 border-dashed border-slate-200 rounded-xl p-20 text-center text-slate-400">
            <p>文章を入力して「図解を生成」をクリックしてください</p>
          </div>
        )}
      </main>

      <footer className="mt-20 text-center text-slate-400 text-sm border-t border-slate-200 pt-8 pb-12">
        &copy; {new Date().getFullYear()} FlowChart AI Generator | 業務効率化を支援
      </footer>
    </div>
  );
};

export default App;
TSX

cat > "$APP_DIR/.env.example" <<'ENV'
# ここにAPIを入れる
# Google AI Studio で取得したAPIキーを設定してください
VITE_GEMINI_API_KEY=AIzaSyDBljntEkcSJdNFtUk3FHch-RRR95o6Cck
ENV

cat > "$APP_DIR/.gitignore" <<'GIT'
node_modules
dist
.DS_Store
.env
.env.local
.env.*.local
GIT

cat > "$APP_DIR/public/favicon.svg" <<'SVG'
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
  <rect width="100" height="100" rx="20" ry="20" fill="#2563eb"/>
  <path d="M30 30h10v40H30zM60 30h10v40H60z" fill="#fff"/>
</svg>
SVG

cat > "$APP_DIR/README.md" <<'MD'
# FlowChart AI Generator

自然な日本語の業務説明から、Mermaid形式の業務フローチャートを自動生成するツールです。

## セットアップ

1) インストール
npm install

2) APIキー設定
.env.example をコピーして .env を作成し、APIキーを設定してください。

.env
VITE_GEMINI_API_KEY=ここにAPIを入れる

3) 起動
npm run dev

## 使い方

- 入力欄に業務フロー文章を貼り付け
- 図解を生成 を押す
- SVG保存 / PNG保存 でダウンロード
MD

echo "OK: $APP_DIR を作成しました"
echo "次に実行:"
echo "  cd $APP_DIR"
echo "  npm install"
echo "  cp .env.example .env"
echo "  ( .env の ここにAPIを入れる を自分のAPIキーに置換 )"
echo "  npm run dev"
