<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8"><title>Debug FlowChart AI</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">{ "imports": { "@google/genai": "https://esm.sh/@google/genai@1.0.2" } }</script>
</head>
<body class="bg-slate-900 text-white p-5">
    <div class="max-w-xl mx-auto space-y-4">
        <h1 class="text-xl font-bold text-amber-500">動作診断モード</h1>
        <textarea id="uInput" class="w-full h-20 bg-slate-800 p-2 rounded" placeholder="テスト"></textarea>
        <button id="uBtn" class="w-full bg-amber-600 p-3 rounded font-bold">このボタンを押して診断開始</button>
        
        <div id="uLog" class="bg-black p-4 rounded text-xs font-mono h-64 overflow-auto border border-slate-700">
            <div>> 準備完了。ボタンを押してください。</div>
        </div>
        
        <div id="uPreview" class="bg-white p-4 rounded min-h-[200px] text-black">
            </div>
    </div>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";
        // ★ここにAPIキーを入れてください
        const KEY = "AIzaSyDBljntEkcSJdNFtUk3FHch-RRR95o6Cck"; 

        const log = (m) => { document.getElementById('uLog').innerHTML += `<div>> ${m}</div>`; };
        const target = document.getElementById('uPreview');

        document.getElementById('uBtn').onclick = async () => {
            log("診断開始...");
            if(KEY.includes("あなたのAPIキー")) { log("エラー: APIキーが書き換えられていません！"); return; }
            
            try {
                log("1. Google AIサーバーに接続を試みます...");
                const genAI = new GoogleGenAI(KEY);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                
                log("2. AIに図解コードを作らせています...");
                const res = await model.generateContent("graph TD\nA-->B を出力して");
                const code = res.response.text().replace(/```mermaid|```/g, "").trim();
                log("AIからの応答: " + code);

                log("3. Mermaidで図を描画します...");
                mermaid.initialize({ startOnLoad: false, theme: 'default' });
                target.innerHTML = "";
                const { svg } = await mermaid.render('d' + Date.now(), code);
                target.innerHTML = svg;
                log("成功！図が表示されました。");
            } catch (e) {
                log("！！致命的エラー発生！！");
                log("内容: " + e.message);
                console.error(e);
            }
        };
    </script>
</body>
</html>
