<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlowChart AI Generator</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>

  <script type="importmap">
  {
    "imports": {
      "@google/genai": "https://esm.sh/@google/genai@^1.37.0"
    }
  }
  </script>

  <style>
    :root {
      --bg: #0b1220; --panel: #111a2e; --text: #e5e7eb; --border: #24324d; --accent: #fbbf24;
    }
    body { background: linear-gradient(180deg, var(--bg), #070b14); color: var(--text); font-family: sans-serif; }
    .card { background: rgba(17,26,46,.82); border: 1px solid var(--border); border-radius: 14px; box-shadow: 0 12px 30px rgba(0,0,0,.35); }
    textarea { background: rgba(15,23,42,.9); border: 1px solid var(--border); color: white; outline: none; }
    textarea:focus { border-color: var(--accent); }
    .preview-white { background: white; border-radius: 10px; padding: 20px; min-height: 300px; display: flex; justify-content: center; align-items: center; }
  </style>
</head>

<body class="p-4 md:p-8">
  <div class="max-w-6xl mx-auto">
    <header class="flex justify-between items-end mb-6">
      <div>
        <h1 class="text-2xl font-bold">FlowChart AI Generator</h1>
        <p class="text-xs text-gray-400 mt-1">文章からGemini AIが図解を自動生成します</p>
      </div>
      <div id="status-pill" class="text-[10px] px-3 py-1 bg-slate-800 rounded-full border border-slate-700">準備完了</div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="card p-5">
        <div class="flex justify-between items-center mb-3">
          <span class="text-sm font-semibold text-slate-300">テキスト入力</span>
          <button id="btn-example" class="text-xs text-blue-400 underline">例を入れる</button>
        </div>
        <textarea id="input-text" class="w-full h-48 p-4 rounded-xl text-sm leading-relaxed" placeholder="業務フローを入力してください..."></textarea>
        
        <div class="flex flex-wrap gap-2 mt-4">
          <button id="btn-generate" class="bg-amber-500 hover:bg-amber-600 text-black font-bold py-2.5 px-6 rounded-xl transition-all shadow-lg shadow-amber-500/20">図解を生成</button>
          <button id="btn-copy" class="bg-slate-800 hover:bg-slate-700 py-2 px-4 rounded-xl text-xs border border-slate-600 disabled:opacity-30" disabled>コードをコピー</button>
          <button id="btn-png" class="bg-slate-800 hover:bg-slate-700 py-2 px-4 rounded-xl text-xs border border-slate-600 disabled:opacity-30" disabled>PNG保存</button>
          <button id="btn-svg" class="bg-slate-800 hover:bg-slate-700 py-2 px-4 rounded-xl text-xs border border-slate-600 disabled:opacity-30" disabled>SVG保存</button>
        </div>
        <div id="log-message" class="mt-4 p-3 bg-black/30 border border-slate-800 rounded-lg text-[11px] text-gray-400 min-h-[40px]">文章を入力して「生成」を押してください。</div>
      </div>

      <div class="card p-5">
        <div class="text-sm font-semibold text-slate-300 mb-3">プレビュー</div>
        <div id="capture-target" class="preview-white overflow-auto">
          <div id="mermaid-render-area" class="w-full"></div>
        </div>
        
        <details class="mt-4 bg-black/20 rounded-lg overflow-hidden border border-slate-800">
          <summary class="p-3 text-[11px] cursor-pointer hover:bg-white/5 uppercase tracking-widest text-slate-500">Mermaid Code</summary>
          <pre id="code-output" class="p-3 text-[10px] text-blue-300 whitespace-pre-wrap font-mono"></pre>
        </details>
      </div>
    </div>
  </div>

  <script type="module">
    import { GoogleGenAI } from "@google/genai";

    // 【重要】ここにあなたのAPIキーを貼り付けてください
    const API_KEY = "AIzaSyDBljntEkcSJdNFtUk3FHch-RRR95o6Cck";

    const genAI = new GoogleGenAI(API_KEY);
    const model = genAI.getGenerativeModel({ 
      model: "gemini-1.5-flash",
      systemInstruction: "あなたはMermaid.jsのエキスパートです。業務フローを解析し、必ず graph TD から始まるMermaidコードブロックのみを返してください。余計な説明は不要です。"
    });

    const elInput = document.getElementById('input-text');
    const elRender = document.getElementById('mermaid-render-area');
    const elLog = document.getElementById('log-message');
    const elCode = document.getElementById('code-output');
    const elPill = document.getElementById('status-pill');

    const btnGen = document.getElementById('btn-generate');
    const btnPng = document.getElementById('btn-png');
    const btnSvg = document.getElementById('btn-svg');
    const btnCopy = document.getElementById('btn-copy');

    mermaid.initialize({ startOnLoad: false, theme: 'neutral', securityLevel: 'loose' });

    // 生成メイン処理
    btnGen.onclick = async () => {
      const text = elInput.value.trim();
      if (!text) return;

      btnGen.disabled = true;
      elPill.innerText = "生成中...";
      elLog.innerText = "Gemini AIが文章を解析しています...";

      try {
        const result = await model.generateContent(text);
        let code = result.response.text();
        
        // 抽出
        code = code.replace(/```mermaid/g, "").replace(/```/g, "").trim();
        if(!code.includes("graph")) code = "graph TD\n" + code;

        elCode.innerText = code;
        elLog.innerText = "図を描画しています...";

        // Mermaid描画
        elRender.innerHTML = "";
        const { svg } = await mermaid.render('graph-' + Date.now(), code);
        elRender.innerHTML = svg;

        elLog.innerText = "生成完了しました。保存が可能です。";
        elPill.innerText = "完了";
        [btnPng, btnSvg, btnCopy].forEach(b => b.disabled = false);

      } catch (err) {
        console.error(err);
        elLog.innerText = "エラー: APIキーが無効か、通信に失敗しました。";
        elPill.innerText = "失敗";
      } finally {
        btnGen.disabled = false;
      }
    };

    // PNG保存
    btnPng.onclick = async () => {
      const dataUrl = await htmlToImage.toPng(document.getElementById('capture-target'), { backgroundColor: '#fff' });
      const link = document.createElement('a');
      link.download = `flowchart.png`;
      link.href = dataUrl;
      link.click();
    };

    // 例を入れる
    document.getElementById('btn-example').onclick = () => {
      elInput.value = "申請を受け取る。内容を確認する。不備があれば差し戻す。不備がなければ承認する。";
    };

    // コードコピー
    btnCopy.onclick = () => {
      navigator.clipboard.writeText(elCode.innerText);
      alert("コピーしました");
    };
  </script>
</body>
</html>
