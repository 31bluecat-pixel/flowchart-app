<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowChart AI Generator - Professional Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>
    <script type="importmap">
    { "imports": { "@google/genai": "https://esm.sh/@google/genai@^1.37.0" } }
    </script>
    <style>
        :root { --bg: #0b1220; --panel: #111a2e; --accent: #fbbf24; --border: #24324d; }
        body { background: radial-gradient(circle at top, #1e293b, #070b14); color: #e5e7eb; min-height: 100vh; font-family: 'Inter', sans-serif; }
        .glass-card { background: rgba(17, 26, 46, 0.8); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 1rem; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .preview-area { background: white; border-radius: 0.75rem; min-height: 400px; display: flex; align-items: center; justify-content: center; position: relative; overflow: auto; }
        textarea { background: rgba(15, 23, 42, 0.8); border: 1px solid var(--border); color: #fff; transition: all 0.3s; }
        textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.2); }
        .loading-shimmer { background: linear-gradient(90deg, #111a2e 25%, #1e293b 50%, #111a2e 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="p-6">
    <div class="max-w-7xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-orange-500">FlowChart AI Generator</h1>
                <p class="text-slate-400 text-sm mt-1 flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Gemini 1.5 Flash 連携済み
                </p>
            </div>
            <div id="status-badge" class="px-4 py-2 rounded-full bg-slate-800 border border-slate-700 text-xs font-mono text-slate-300">SYSTEM READY</div>
        </header>

        <div class="grid grid-cols-1 xl:grid-cols-5 gap-8">
            <div class="xl:col-span-2 space-y-6">
                <div class="glass-card p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-sm font-bold uppercase tracking-widest text-slate-400 font-mono">Input Description</h2>
                        <button id="example-btn" class="text-xs text-amber-500 hover:text-amber-400 transition">例文を挿入</button>
                    </div>
                    <textarea id="prompt-input" class="w-full h-64 p-4 rounded-lg resize-none text-sm leading-relaxed" placeholder="業務フローを日本語で自由に記述してください..."></textarea>
                    
                    <div class="mt-6 space-y-3">
                        <button id="generate-btn" class="w-full bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-400 hover:to-orange-500 text-black font-black py-4 rounded-xl transition-all transform active:scale-95 shadow-xl shadow-amber-900/20">
                            図解を生成する (AI解析)
                        </button>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="png-btn" disabled class="bg-slate-800 hover:bg-slate-700 disabled:opacity-30 disabled:cursor-not-allowed py-3 rounded-lg text-xs font-bold border border-slate-700 transition">PNGで保存</button>
                            <button id="copy-btn" disabled class="bg-slate-800 hover:bg-slate-700 disabled:opacity-30 disabled:cursor-not-allowed py-3 rounded-lg text-xs font-bold border border-slate-700 transition">コードをコピー</button>
                        </div>
                    </div>
                </div>

                <div id="console-log" class="glass-card p-4 h-32 overflow-y-auto font-mono text-[10px] text-slate-500 space-y-1">
                    <div>> System initialized. Awaiting user input...</div>
                </div>
            </div>

            <div class="xl:col-span-3 space-y-6">
                <div class="glass-card p-6 min-h-[500px] flex flex-col">
                    <h2 class="text-sm font-bold uppercase tracking-widest text-slate-400 font-mono mb-4">Live Preview</h2>
                    <div id="capture-box" class="preview-area flex-grow shadow-inner">
                        <div id="mermaid-root" class="w-full p-4">
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        // 【ここをあなたのキーに！】
        const API_KEY = "AIzaSyDBljntEkcSJdNFtUk3FHch-RRR95o6Cck"; 

        const genAI = new GoogleGenAI(API_KEY);
        const model = genAI.getGenerativeModel({ 
            model: "gemini-1.5-flash",
            systemInstruction: "あなたはMermaid.jsのエキスパートです。文章を解析し、必ず「graph TD」から始まるMermaidコードだけを出力してください。説明や挨拶は一切禁止です。もし分岐があるなら「-- はい -->」のように日本語で矢印にラベルをつけてください。"
        });

        const elements = {
            input: document.getElementById('prompt-input'),
            render: document.getElementById('mermaid-root'),
            log: document.getElementById('console-log'),
            btnGen: document.getElementById('generate-btn'),
            btnPng: document.getElementById('png-btn'),
            btnCopy: document.getElementById('copy-btn'),
            status: document.getElementById('status-badge'),
            example: document.getElementById('example-btn')
        };

        mermaid.initialize({ startOnLoad: false, theme: 'neutral', fontFamily: 'Inter' });

        function addLog(msg, color = 'text-slate-500') {
            const div = document.createElement('div');
            div.className = color;
            div.innerText = `> ${msg}`;
            elements.log.appendChild(div);
            elements.log.scrollTop = elements.log.scrollHeight;
        }

        elements.example.onclick = () => {
            elements.input.value = "顧客が注文する。在庫を確認し、在庫があれば発送準備。在庫がなければ取り寄せ依頼を出す。最後に完了メールを送る。";
        };

        elements.btnGen.onclick = async () => {
            const prompt = elements.input.value.trim();
            if (!prompt) return alert("文章を入力してください");

            elements.btnGen.disabled = true;
            elements.status.innerText = "AI THINKING...";
            elements.status.className = "px-4 py-2 rounded-full bg-amber-900/30 border border-amber-700 text-xs font-mono text-amber-400 animate-pulse";
            addLog("Calling Gemini AI API...", "text-amber-400");

            try {
                const result = await model.generateContent(prompt);
                let code = result.response.text();
                
                // 強力なコード抽出処理
                code = code.replace(/```mermaid/g, "").replace(/```/g, "").trim();
                const startIdx = code.indexOf("graph");
                if (startIdx !== -1) code = code.substring(startIdx);

                addLog("AI response received. Rendering diagram...");
                elements.render.innerHTML = "";
                
                const { svg } = await mermaid.render('svg-' + Date.now(), code);
                elements.render.innerHTML = svg;

                addLog("Success! Diagram generated.", "text-green-400");
                elements.status.innerText = "RENDER SUCCESS";
                elements.status.className = "px-4 py-2 rounded-full bg-green-900/30 border border-green-700 text-xs font-mono text-green-400";
                
                elements.btnPng.disabled = false;
                elements.btnCopy.disabled = false;
                elements.btnCopy.onclick = () => {
                    navigator.clipboard.writeText(code);
                    addLog("Code copied to clipboard.");
                };

            } catch (err) {
                console.error(err);
                addLog(`Error: ${err.message}`, "text-red-400");
                elements.status.innerText = "SYSTEM ERROR";
                elements.status.className = "px-4 py-2 rounded-full bg-red-900/30 border border-red-700 text-xs font-mono text-
